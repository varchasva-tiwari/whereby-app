<html xmlns:th="http://www.w3.org/1999/xhtml">

<head>
	<title>openvidu-mvc-java</title>

	<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"></meta>
	<link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"></link>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<!-- Bootstrap -->
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"
			integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
		  integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
		  crossorigin="anonymous"></link>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
			integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
			crossorigin="anonymous"></script>
	<link rel="stylesheet"
		  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"></link>
	<!-- Bootstrap -->

	<link rel="styleSheet" href="style.css" type="text/css" media="screen"></link>
	<script src="openvidu-browser-2.15.0.js"></script>
</head>

<body>

<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<a class="navbar-brand" href="/">
				<img class="demo-logo" src="images/openvidu_vert_white_bg_trans_cropped.png"/> MVC Java</a>
			<a class="navbar-brand nav-icon"
			   href="https://github.com/OpenVidu/openvidu-tutorials/tree/master/openvidu-mvc-java"
			   title="GitHub Repository"
			   target="_blank">
				<i class="fa fa-github" aria-hidden="true"></i>
			</a>
			<a class="navbar-brand nav-icon" href="http://www.docs.openvidu.io/en/stable/tutorials/openvidu-mvc-java/"
			   title="Documentation" target="_blank">
				<i class="fa fa-book" aria-hidden="true"></i>
			</a>
		</div>
	</div>
</nav>


<div class="container">
	<div class="row justify-content-center">
		<div id="xx" class="btn btn-danger">turn off video</div>
		<div id="yy" class="btn btn-success">turn on video</div>
	</div>
</div>

<div id="main-container" class="container">
	<div id="logged">
		<div id="session">
			<div id="session-header">
				<h1 th:text="${sessionName}" id="session-title"></h1>
				<form action="/leave-session" method="post">
					<input type="hidden" name="session-name" th:value="${sessionName}"></input>
					<input type="hidden" name="token" th:value="${token}"></input>
					<button id="buttonLeaveSession" class="btn btn-large btn-danger" type="submit"
							onclick="leaveSession()">
						Leave session
					</button>
				</form>
			</div>
			<div id="main-video" class="col-md-6">
				<p class="nickName"></p>
				<p class="userName"></p>
				<video autoplay="autoplay" playsinline="true"></video>
			</div>
			<div id="video-container" class="col-md-6"></div>
		</div>
	</div>
</div>



<div class="conatiner">
	<div class="row justify-content-center">
		<div id="pannel" class="col-6 d-flex flex-column justify-content-start align-items-center">

		</div>
	</div>
</div>

<div style="height:100px"></div>
<!--<footer class="footer">-->
<!--    <div class="container">-->
<!--        <div class="text-muted">OpenVidu Â© 2017</div>-->
<!--        <a href="http://www.openvidu.io/" target="_blank">-->
<!--            <img class="openvidu-logo" src="images/openvidu_globe_bg_transp_cropped.png"/>-->
<!--        </a>-->
<!--    </div>-->
<!--</footer>-->

</body>

<script th:inline="javascript">

	// Get all the attributes from the template in Thymeleaf style
	var sessionName = [[${ sessionName }]];
	var token = [[${ token }]];
	var nickName = [[${ nickName }]];
	var userName = [[${ userName }]];

	let publisher;
    const ov = new OpenVidu();
    let session = ov.initSession();

	session.connect(token,{clientData:nickName})
    .then(()=>{
            $("#session-title").text(sessionName);
            $("#join").hide();
            $("#session").show();
            publisher = ov.initPublisher("video-container",{
                videoSource:undefined,
                audioSource:undefined,
                publishAudio:false,
                publishVideo:true,
                resolution:'640x480',
                framRate:30,
                insertMode:'APPEND',
                mirror:true
            })
            publisher.on("videoElementCreated",()=>{
            addPannel(document.getElementById("pannel"),publisher.stream);
        })
        session.publish(publisher);
    })
    .catch()

    session.on("streamCreated",(event)=>{
        let subscriber = session.subscribe(event.stream,"video-container");
        subscriber.on("videoElementCreated",()=>{
            addPannel(document.getElementById("pannel"),event.stream);
        })
    })

    session.on("streamDestroyed",(event)=>{
         console.log("stream destroyed.....")
         document.getElementById("pannel").querySelector("#"+event.stream.connection.connectionId+"-1").closest("div").remove();
    })

    document.getElementById("xx").addEventListener("click",(e)=>{
        const signal = {
            type:"turnOffVideo",
            to:[]
        }
        session.streamManagers.forEach(member=>{
            if(member.stream.connection.connectionId !== session.connection.connectionId){
                signal.to.push(member.stream.connection);
            }
        })
        session.signal(signal)
    })

    document.getElementById("yy").addEventListener("click",(e)=>{
        const signal = {
            type:"turnOnVideo",
            to:[]
        }
        session.streamManagers.forEach(member=>{
            if(member.stream.connection.connectionId !== session.connection.connectionId){
                signal.to.push(member.stream.connection);
            }
        })
        session.signal(signal)
    })

    session.on("signal:turnOffVideo",()=>{
        publisher.publishVideo(false);
    })

    session.on("signal:turnOnVideo",()=>{
        if(! publisher.stream.videoActive){
            if(confirm("turn camera on")){
                    publisher.publishVideo(true);
                }
        }
    })

    function addPannel(container,stream){
            const div = createElements("div","d-flex w-100 justify-content-around p-1 my-2");
            const h4 = createElements("h3",null,JSON.parse(stream.connection.data.split("%/%")[0]).clientData);
            const buttonOff = createElements("button","btn btn-danger","Video off");
            const buttonOn = createElements("button","btn btn-success","Video On");
            const buttonSub = createElements("button","btn btn-success","Subscribe to Video toggle");
            buttonOff.id = stream.connection.connectionId+"-"+1;
            buttonOn.id = stream.connection.connectionId+"-"+2;
            buttonSub.id = stream.connection.connectionId+"-"+3;
            div.append(h4);
            div.append(buttonOff);
            div.append(buttonOn);
            div.append(buttonSub);
            container.append(div);
            buttonOff.addEventListener("click",(e)=>turnOffVideo(e))
            buttonOn.addEventListener("click",(e)=>turnOnVideo(e))
            buttonSub.addEventListener("click",(e)=>toggleSubscriber(e))
    }

    function createElements(type,css=null,content=null){
        const ele = document.createElement(type);
        if(css!=null) ele.className = css;
        if(content!=null) ele.innerText = content;
        return ele;
    }

    function turnOffVideo(e){
        const signal = {
            type:"turnOffVideo",
            to:[]
        }
        const id = e.target.id.split("-")[0]
        console.log(id)
        signal.to.push(session.streamManagers.find(member=>member.stream.connection.connectionId === id).stream.connection)
        session.signal(signal);
    }

    function turnOnVideo(e){
        const signal = {
            type:"turnOnVideo",
            to:[]
        }
        const id = e.target.id.split("-")[0]
        console.log(id)
        signal.to.push(session.streamManagers.find(member=>member.stream.connection.connectionId == id).stream.connection)
        session.signal(signal);
    }

    function toggleSubscriber(e){
        let id = e.target.id.split("-")[0];
        console.log(id);
        let subscriber = session.streamManagers.find(member=>member.stream.connection.connectionId === id)
        console.log(subscriber);
        if("subscribeToAudio" in subscriber.properties){
            subscriber.subscribeToVideo(! subscriber.stream.videoActive)
        }else if("publishVideo" in subscriber.properties){
            subscriber.publishVideo(! subscriber.stream.videoActive)
        }
    }
</script>

</html>
